<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="《Kafka技术内幕》--读书笔记5"><meta name="keywords" content="java,kafka,Kafka技术内幕"><meta name="author" content="keon,undefined"><meta name="copyright" content="keon"><title>《Kafka技术内幕》--读书笔记5 | keon随便写写</title><link rel="shortcut icon" href="/my-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?ae0586f75159e5097cb79871b2fdb3a1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#创建并初始化消费者连接器"><span class="toc-number">1.</span> <span class="toc-text">创建并初始化消费者连接器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#消费者客户端的线程模型"><span class="toc-number">2.</span> <span class="toc-text">消费者客户端的线程模型</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#重新初始化消费者"><span class="toc-number">3.</span> <span class="toc-text">重新初始化消费者</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">keon</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">9</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">3</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">2</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://raw.githubusercontent.com/awdclijn/awdclijn.github.io/master/img/kim-holtermand-reflections.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">keon随便写写</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">《Kafka技术内幕》--读书笔记5</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-09-12</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/读书笔记/">读书笔记</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/读书笔记/Kafka技术内幕/">Kafka技术内幕</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">1,453</span><span class="post-meta__separator">|</span><span>阅读时长: 4 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>消费者的配置信息要指定连接的ZK集群以及消费组编号。消费者客户端会通过消费者连接器(ConsumerConnector)连接ZK集群，获取分配的分区，创建每个主题对应的消息流(KafkaStream),最后迭代消息流，读取每条消息，并完成具体的业务处理逻辑(这里只是简单地打印出收到的每条信息)。</p>
<p>消费者客户端通过消费者连接器读取消息的具体步骤如下。</p>
<ol>
<li>消费者的配置信息指定订阅的主题和主题对应的线程数，每个线程对应一个消息流。</li>
<li>Consumer对象通过配置文件创建基于ZK的消费者连接器。</li>
<li>消费者连接器根据主题和线程数创建多个消息流。</li>
<li>在每个消息流通过循环消费者迭代器(ConsumerIterator)读出消息。</li>
</ol>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fve31c9uixj315w0hmap1.jpg" alt=""></p>
<a id="more"></a>
<h1 id="创建并初始化消费者连接器"><a href="#创建并初始化消费者连接器" class="headerlink" title="创建并初始化消费者连接器"></a>创建并初始化消费者连接器</h1><p>默认的消费者连接器实现类是ZookeeperConsumerConnector，消费者连接器还会协调下面的各个组件来读取消息。</p>
<ul>
<li>listeners。注册主题分区的更新、会话超时、消费者成员变化事件，触发再平衡。</li>
<li>zkUtils。从ZK中获取主题、分区、消费者列表，为再平衡时的分区分配提供决策。</li>
<li>topicRegistry。消费者分配的分区，结构是“主题→(分区→分区信息)”。</li>
<li>fetcher。消费者拉取线程的管理类，拉取线程会向服务端拉取分区的消息。</li>
<li>topicThreadldAndQueues。消费者订阅的主题和线程数，每个线程对应一个队列。</li>
<li>offsetsChannel。偏移量存储为Kafka内部主题时，需要和管理消费组的协调者通信。</li>
</ul>
<p>监听器(1)是消息消费事件的导火索，一旦触发了再平衡，需要从ZK中读取所有的分区和已注册的消费者(2)。然后通过分区分配算法，每个消费者都会分配到不同的分区列表(3)。接着拉取线程开始拉取对应的分区消息(4)，并将拉取到的消息放到每个线程的队列中(5)，最后消费者客户端就可以从队列中读取出消息了。另外，为了及时保存消费进度，我们还需要将偏移量保存至offsetsChannel通道对应的节点中(6)。</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fve3a31wmpj312q0q2nl9.jpg" alt=""></p>
<h1 id="消费者客户端的线程模型"><a href="#消费者客户端的线程模型" class="headerlink" title="消费者客户端的线程模型"></a>消费者客户端的线程模型</h1><p>消费者连接器的createMessageStreams()方法会调用consume()方法，但consume()方法并不真正消费数据，而只是为消费消息做准备工作。</p>
<ol>
<li>根据客户端传入的topicCountMap构造对应的队列和消息流，消息流引用了队列。</li>
<li>在ZK的消费组父节点下注册消费者子节点。</li>
<li>执行初始化工作，触发再平衡，为消费者分配分区，拉取线程会拉取消息放到队列中。</li>
<li>返回消息流列表，队列中有数据时，客户端就可以从消息流中迭代读取消息。</li>
</ol>
<p>消费者客户端线程模型的主要概念有消费者线程、队列、消息流，这三者的关系都是一一对应的。如果将线程模型和服务端的分区再结合起来，一个线程允许分配多个分区，那么多个分区会共用同一个线程对应的一个队列和一个消息流。下面我们分析几个和消费者线程模型相关的变量。</p>
<ul>
<li>topicCountMap，设置主题及其对应的线程个数，每个钱程都对应一个队列和一个消息流。</li>
<li>consumer时，即“消费者编号”，用“消费组名称+随机值”表示，指定消费者在消费组中的唯一编号。</li>
<li>ConsumerThreadid，即“消费者线程编号”，用“消费者编号+线程编号”表示。</li>
<li>consumerThreadidsPerTopicMap，表示每个主题和消费者线程编号集合的映射关系。</li>
<li>topicThreadids，表示所有的消费者线程编号集合，相同主题的线程会在同一个数组里。</li>
<li>topicThreadidAndQueues，表示消费者线程和队列的映射关系，因为每个线程对应一个队列。</li>
</ul>
<p>消费者客户端只需要指主订阅的主题和线程数量，具体主题分成几个分区、线程分配到了哪些分区、分区分布在哪些节点上，对客户端都是透明的。客户端的关注点是每个线程都对应一个队列，每个队列都对应了一个消息流，只要队列中有数据，就能从消息流中迭代读取出消息。</p>
<p>队列作为消息流和拉取线程的共享内存数据结构，会通过消费者连接器的topicThreadldAndQueues全局引用，传递到拉取线程。当拉取线程往队列中填充数据时，消费者客户端就可以通过消息流从队列读取消息。</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fve4139m62j310u0am107.jpg" alt=""></p>
<h1 id="重新初始化消费者"><a href="#重新初始化消费者" class="headerlink" title="重新初始化消费者"></a>重新初始化消费者</h1><p>消费者连接器的consume()方法在注册消费者至ZK后，调用reinitializeConsumer()方法执行重新初始化。消费者启动时希望被加入消费组，必须执行一次初始化方法，并触发消费组内所有消费者成员(当然也包括自己)的再平衡。</p>
<p>每个消费者在启动时都要订阅3种事件:会话超时事件、消费组的子节点变化事件(消费者增减)、主题的数据变化事件(分区增减)。这3种事件任何一个发生，都会触发再平衡操作。如果从消费组级别来看，其他消费者也会订阅这些事件，也都会发生再平衡。即消费组中的所有消费者都会发生再平衡。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">keon</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://awdclijn.github.io/2018/09/12/《Kafka技术内幕》-读书笔记5/">https://awdclijn.github.io/2018/09/12/《Kafka技术内幕》-读书笔记5/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://awdclijn.github.io" target="_blank">keon随便写写</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java/">java</a><a class="post-meta__tags" href="/tags/kafka/">kafka</a><a class="post-meta__tags" href="/tags/Kafka技术内幕/">Kafka技术内幕</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/11/09/论软件架构的选择/"><i class="fa fa-chevron-left">  </i><span>论软件架构的选择</span></a></div><div class="next-post pull-right"><a href="/2018/09/08/《Kafka技术内幕》-读书笔记4/"><span>《Kafka技术内幕》--读书笔记4</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2018 By keon</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script></body></html>